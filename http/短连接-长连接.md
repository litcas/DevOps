- [HTTP 短链接与长连接](#http-短链接与长连接)
  - [1. 短连接](#1-短连接)
  - [2. 长连接](#2-长连接)
  - [3. 长连接与短连接的区别](#3-长连接与短连接的区别)
  - [4. HTTP 长连接实例](#4-http-长连接实例)
  - [5. 优缺点](#5-优缺点)
  - [6. 长连接 / 短连接的选择](#6-长连接--短连接的选择)
  - [7. Refer Links](#7-refer-links)

# HTTP 短链接与长连接

在 OSI 模型中，HTTP 处于应用层，依赖于传输层 TCP，因此 **HTTP 长连接和短连接本质上指的是 TCP 的长连接和短连接**。

**TCP 短连接在三次握手建立后，一般只会在 client/server 间传递一次读写操作，然后通过四次挥手关闭连接；TCP 长连接在三次握手建立后，会在 client/server 间传递多次读写操作，直到有一方主动结束或者连接超时，才通过四次挥手关闭连接**。

## 1. 短连接

**HTTP 短连接是指通讯双方有数据交互时，就建立一个连接，数据发送完成后，则断开此连接，即每次连接只完成一项业务的发送**。

**在 HTTP/1.0 中，默认使用的是短连接。浏览器和服务器每进行一次 HTTP 操作就建立一次连接，然后请求结束就直接中断连接**。一个普通页面如果有近百个 Web 资源（JavaScript、CSS、图片），那么浏览器每请求一次资源都会新建一个 HTTP 会话，每次会创建一个 TCP 连接，那么每次都要经历 TCP 的三次握手和四次挥手。在 HTTP 短连接的状态下，浏览器和我们的 Web 服务器重复的进行这样的操作：建立连接–>数据传输–>关闭连接。

## 2. 长连接

**从 HTTP/1.1 开始，默认使用长连接，即在请求头部中添加字段 connection:keep-alive，且主流浏览器和 Web 服务器默认情况下都使用的是 HTTP/1.1**。

长连接的建立需要客户端和服务端都支持。

P.S. HTTP 协议的无状态的，指的是协议对于事务处理没有记忆能力，服务器不知道客户端是什么状态，即打开一个服务器上的网页和之前打开这个服务器上的网页之间没有任何联系。但注意，**无状态不代表 HTTP 不能保持 TCP 连接，保持 TCP 连接指的是客户端的多次 HTTP 请求使用同一个 TCP 连接，但多次请求之间没有任何状态的保持**。

## 3. 长连接与短连接的区别

![image](http://img.cdn.firejq.com/jpg/2018/1/23/0f35a193b519097c44e515f6d72d15a2.jpg)

## 4. HTTP 长连接实例

1. 客户端向 web 服务器发起请求，请求头部默认包含字段 keep-alive，即告诉 Web 服务器，“我要使用长连接”：

   ![image](http://img.cdn.firejq.com/jpg/2018/1/23/db7c495dc6aaf4f7c5e1f64b40aaf6ad.jpg)

1. web 服务器为 nginx，默认开启了长连接，在配置文件中可配置长连接超时时间，此处为 60 秒：
    ```
    keepalive_timeout 60;
    ```
    服务器响应，确认使用长连接：
    ![image](http://img.cdn.firejq.com/jpg/2018/1/23/7da7df08e0d98a517d09b3edd6987c17.jpg)

1. 此次请求响应结束后，客户端和服务器之间传输 HTTP 数据的 TCP 连接不会关闭<!--TODO: 那什么时候才会关闭 -->，如果客户端再次访问这个服务器上的资源，会继续使用这条已经建立的连接。

    在长连接的情况下，查看服务器的 TCP 连接可以看到一个 TCP 的 socket，状态是 ESTABLISHED：
    ```shell
    #netstat -na | grep  192.168.99.159:80
    tcp        0     0 192.168.99.159:80       192.168.99.50:24584     ESTABLISHED
    ```

1. 过了 60 秒之后，再次查看这个 socket 的状态，会发现已经转变为 TIME_WAIT
    ```shell
    #netstat -na | grep  192.168.99.159:80
    tcp        0     0 192.168.99.159:80      192.168.99.50:24584    TIME_WAIT
    ```
    在 Linux 系统中 TIME_WAIT 状态会持续 60 秒，在这期间这个 Socket 不会被释放；

因此，客户端访问服务器每发起一个 HTTP 长连接请求，在 Web 服务器端会占用一个 Socket 的连接，加上 TCP 建立连接的时间要 120 多秒。

## 5. 优缺点

- 优点

  避免了频繁的建立和销毁 TCP 连接，降低网络阻塞，提高了资源请求的速度。

- 缺点

  在高并发环境下，web 服务器需要维护大量的 socket 连接，耗费大量系统资源 -- 需要调整 `keepalive_timeout` 来改善（长连接的状态下，一个 Socket 的存在时间是建立 TCP 连接时间 + `keepalive_timeout` 时间 + `TIME_WAIT` 时间）。

## 6. 长连接 / 短连接的选择

实例：
- 数据库的连接一般会用长连接，因为如果用短连接频繁的通信会造成 socket 错误，而且频繁的 socket 创建也是对资源的浪费。
     
- WEB 网站的 HTTP 服务一般都用短链接，因为长连接对于服务端来说会耗费一定的资源，而像 WEB 网站这么频繁的成千上万甚至上亿客户端的连接用短连接会更省一些资源，如果用长连接，而且同时有成千上万的用户，如果每个用户都占用一个连接的话，压力可想而知。所以并发量大，但每个用户无需频繁操作的情况下需用短连好。

## 7. Refer Links
